SHELL := /bin/bash
.ONESHELL:  # TÃ¼m komutlarÄ± tek bir shell iÃ§inde Ã§alÄ±ÅŸtÄ±rmak iÃ§in
.SHELLFLAGS = -e  # Hata durumunda sÃ¼reci durdur

# .env dosyasÄ±nÄ±n bulunduÄŸu yol (bir Ã¼st klasÃ¶rde environments klasÃ¶rÃ¼)
ENV_FILE := ../environments/makefile.env

# .env dosyasÄ±nÄ± iÃ§eri aktar
include $(ENV_FILE)
export $(shell sed 's/=.*//' $(ENV_FILE)) # .env iÃ§indeki tÃ¼m deÄŸiÅŸkenleri export eder

# Renkli Ã§Ä±ktÄ± tanÄ±mlarÄ±
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RED    := \033[0;31m
RESET  := \033[0m

# BaÅŸlangÄ±Ã§ ve bitiÅŸ mesajlarÄ± iÃ§in yardÄ±mcÄ± fonksiyon (Ã¶zel mesaj desteÄŸi eklendi)
define print_message
	@echo -e "$(YELLOW)ğŸš€ Running: $(1)$(RESET)"
	@echo -e "$(GREEN)â¡ï¸  $(2)$(RESET)"
	@$(1); \
	if [ $$? -ne 0 ]; then \
		echo -e "$(RED)âŒ Error occurred in: $(1)$(RESET)"; \
		exit 1; \
	fi
	@echo -e "$(GREEN)âœ… TamamlandÄ±: $(1)$(RESET)"
endef



# .sh dosyalarÄ±na yÃ¼rÃ¼tme izni ver
set-permissions:
	@echo "Setting execute permissions for .sh scripts..."
	@chmod +x $(SCRIPT_DIR)/*.sh || { echo "Error: Failed to set execute permissions for scripts in $(SCRIPT_DIR)."; exit 1; }
	@echo "Execute permissions set successfully for all scripts."

# Ã‡oklu dosya doÄŸrulama iÅŸlemi iÃ§in bir hedef
verify-all:		
	@echo "Defining VERIFY_INPUT..."	
	@echo "Starting signature verification for all files..."
	@$(VERIFY_SIGNATURE_FILE) "$(VERIFY_INPUT)" || { \
		echo "Error: Signature verification failed for the following files:"; \
		echo "$(VERIFY_INPUT)"; \
		exit 1; \
	}
	@echo "All files verified successfully."


.PHONY: zookeeper-1 broker-1 check-all system-setup build help

# Ä°lk Makefile'i Ã§alÄ±ÅŸtÄ±rma hedefi (Ã¶zel mesaj ile)
zookeeper-1:
	$(call print_message, $(MAKE) -C $(ZOOKEEPER1) $(MAKEFILE_COMMAND) -f $(MAKEFILE_NAME), $(ZOOKEEPER1_INFO_MSG))

# Ä°kinci Makefile'i Ã§alÄ±ÅŸtÄ±rma hedefi (farklÄ± Ã¶zel mesaj ile)
broker-1:
	$(call print_message, $(MAKE) -C $(BROKER1) $(MAKEFILE_COMMAND) -f $(MAKEFILE_NAME), $(BROKER1_INFO_MSG))

# TÃ¼m Makefile'leri sÄ±rasÄ±yla Ã§alÄ±ÅŸtÄ±r
check-all: zookeeper-1 broker-1

# Setup iÅŸlemleri: EÄŸer SETUP_SPECIFIER true ise, gerekli iÅŸlemleri Ã§alÄ±ÅŸtÄ±r
system-setup: set-permissions verify-all
	@if [ "$(SETUP_SPECIFIER)" = "true" ]; then \
		$(MAKE) zookeeper-1 broker-1 || exit 1; \
	else \
		echo -e "$(RED)Setup is not specified. Skipping setup.$(RESET)"; \
	fi

# Build iÅŸlemi: Setup iÅŸlemi Ã§aÄŸrÄ±lÄ±r
build: system-setup

# YardÄ±mcÄ± hedef
help:
	@echo -e "$(GREEN)KullanÄ±m:$(RESET)"
	@echo -e "  make check-network-1  - zookeeper-1 run"
	@echo -e "  make check-network-2  - broker-1 run"
	@echo -e "  make check-all        - zookeeper-1 and broker-1 run"
	@echo -e "  make system-setup     - runs system setup if specified"
	@echo -e "  make build            - builds after setup"
	@echo -e "  make help             - help command"
